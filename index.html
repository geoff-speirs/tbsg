<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
</head>

<body>
<p id="test_failures" style="white-space: pre;">
</p>
<p id="map" style="white-space: pre;">
  Starting...
</p>
<p>
  <button type="button" id="j_button">J</button>
</p>

<script>  
  class Player {
    constructor(x, y){
      this.x = x;
      this.y = y;
    }
    moveRight(){
      this.x += 1;
    }
    moveLeft(){
      this.x -= 1;
    }
    moveDown(){
      this.y += 1;
    }
    moveUp(){
      this.y -= 1;
    }
  }
  
  const PlayerCommand = {
    MoveRight: "MoveRight",
    MoveLeft: "MoveLeft",
    MoveDown: "MoveDown",
    MoveUp: "MoveUp"
  }
  
  class Game {
    constructor(player, map){
      this.player = player;
      this.map = map;
    }
    update(command){
      if (command === PlayerCommand.MoveRight){
        this.player.moveRight();
      } else if (command === PlayerCommand.MoveLeft){
        this.player.moveLeft();
      } else if (command === PlayerCommand.MoveDown){
        this.player.moveDown();
      } else if (command === PlayerCommand.MoveUp) {
        this.player.moveUp();
      }
    }
  }
  
  const render = (map) => {
    return map.map((lines) => lines.map(tile => { 
        if (tile instanceof Player) return "P";
        return "T";
      }).join("")).join("\n");
  };
  
  const map = document.getElementById("map");
  
  
  
  {
    const assertEqual = (expected, result, message) => {
      if (expected !== result){
        const detailMsg = message ?? "";
        throw new Error(`${detailMsg}: Expected ${result} to be ${expected}`);
      }
    };
    
    tests = [
      ["rendering tiles", 
        [
          ["T", [[1]]],
          ["TT", [[1,2]]],
          ["TT\nTT", [[1,2],[3,4]]]
        ],
        ([expected, data]) => {
          const result = render(data);
          assertEqual(expected, result);
        }
      ],
      ["rendering player",
        [
          ["TT\nTP", [[1,2],[3,new Player()]]]
        ],
        ([expected, data]) => {
          const result = render(data);
          assertEqual(expected, result);
        }
      ],
      ["moving player",
        [
          [[1, 0], [0, 0], PlayerCommand.MoveRight, "right"],
          [[0, 0], [1, 0], PlayerCommand.MoveLeft, "left"],
          [[0, 1], [0, 0], PlayerCommand.MoveDown, "down"],
          [[0, 0], [0, 1], PlayerCommand.MoveUp, "up"]
        ],
        ([[expectedX, expectedY], [startX, startY], command, message]) => {
          const player = new Player(startX, startY);
          const game = new Game(player);
          game.update(command, player);
          assertEqual(expectedX, game.player.x, message);
          assertEqual(expectedY, game.player.y, message);
        }
      ]
    ];
  
    var failures = [];
    tests.forEach(([description, dataList, test]) => dataList.forEach((data) => {
        try{
          test(data);
        }
        catch (error) {
          failures.push(`Error ${description} ${error.message}`);
        }
      })
    );
    document.getElementById("test_failures").textContent = failures.join("\n");
  }
  
  const mapElem = document.getElementById("map");
  class Engine {
    constructor(game){
      this.game = game;
      render(game.map);//render initial
    }
    
    progress(command){
      game.update(command);
      mapElem.textContent = render(game.map);
    }
  }
  
  const player = new Player(0, 0);
  const game = new Game(player, [["T", "T"], ["T", "T"]]);
  const engine = new Engine(game);
  mapElem.textContent = render(game.map);
  
  
  
  
  
  document.addEventListener("keydown", (event) => {
    switch (event.code) {
      case "KeyJ":
        game.update(PlayerCommand.MoveDown);
        break;
    }
  });
  
  document.getElementById("j_button").onclick = (event) => {
    engine.progress(PlayerCommand.MoveDown)
  };
  
  
</script>
</body>

</html>